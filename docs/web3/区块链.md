

## 基础概念

- 【区块】链是一种技术
- 【比特币】是基于区块链的第一代加密货币，在比特币网络上使用。
- 【比特币网络】主要是一个加密货币系统，主要用于点对点的货币交易。仅仅支持有限的脚本语言和简单智能合约功能。
- 【以太币】是在以太坊上使用的货币，在以太坊上作为主币。
- 【以太坊网络】是一个提供更广泛功能的区块链平台，支持各种去中心化应用和智能合约。



## 以太坊网络

以太坊网络是个账本，以太币在物理上不存在的，一个用户有多少钱，并不是有对应的哪一个以太币归属他，只是账本上记录他具有多少钱。

以太坊网络是去中心化的，由成千上万的节点（旷工的矿机）组成。

## 账号

### 如何生成账号
去中心化，不同区块链生成账号都是在本地生成，只是生成账号规则的不同，利用（公钥、私钥）根据不同生成规则生成账号地址。
1. 在**本地**生成 32/64 位 16 进制的**随机数**。
2. 随机数生成 **私钥**、**公钥**。
3. 公/私钥生成**账号地址**。

部分跨链钱包 app，是用同一公/私钥，在不同区块链上生成账号地址，由于生成规则不同，用一公/私钥在不同区块链上生成了不同的账号地址。实现一对多。

只要账号符合区块链生成规则，它就被视为有效地址，可以接收资产，没有传统意义上的“注册”过程。

新创建的账号虽然是有效地址，但由于没有人跟他交易过，区块链上没有它的交易记录，需要别的账号交易过来时才会产生交易记录。

账号根据账户的合约代码，区分为个人账号、合约账号。

### 账号
账号通常包含以下元素：
- Nonce（实际上是计数器）：从0开始，并且每当该账号发起一笔新交易时，其 nonce 值就会递增。每笔交易都会包含该账号当前的 nonce 值。区块链网络会检查每个交易的 nonce 值，确保它是按顺序并且没有被使用过，被使用过了，那本次交易就被废弃了。防止重放攻击、重复交易。
- 账户目前的以太币余额 (主币）：以太币 (Ether)用于支付交易费用。以太币的最小单位为 Wei，最大单位为以太，`1 Ether=10^18 Wei`，`Wei` 单位很小是为了进行整数计算。
- 账户的合约代码：有的话为智能合约账号，没有为个人账号，但未来可以改变转为智能合约账号。
- 账户的存储： (默认为空)。合约账号存放存储数据（状态）和合约代码。


## 交易

### 交易模型

每个区块链网络，都有自己的交易模型：
- 以太坊网络基于账户的模型
- 比特币网络基于 UTXO 的模型

账户模型和 UTXO 模型有本质的不同，基于账户的模型直接反映每个账户的当前状态，而 UTXO 模型通过跟踪每个未花费的输出来确定账户的余额。

基于账户的模型：账户的余额是直接从以太坊的全局状态中读取的，交易执行时，以太坊网络会进行验证并更新全局状态。

"状态"是指包括所有账户（包括普通用户账户和智能合约账户）的当前信息，包括账户的余额、存储的数据和智能合约的代码（当然代码一经发布就不可变）。

每次交易的本质上，是从一个明确的全局状态转移到另一个明确的全局状态，这些状态包括了所有账户的余额、合约状态和其他相关信息。与 UTXO 模型，有本质的不同。

**区块链网络决定了交易模型，在该区块链网络中每次交易都是基于该交易模型。**

区块链网络中可以交易主币，至于交易其他币种，需要通过**代币 WBTC (Wrapped Bitcoin)**实现。

### 交易的特性

只能增量操作：增加交易，无法删除、修改交易。

形式：
- 发起交易只交易币
- 调用一个智能合约


### 每次交易的基本元素

无论是哪种交易模型，交易的基本元素通常包括：
- 接收地址：合约账号地址或个人账号地址
- 发送者签名：用于非对称加密验证发送人，（公钥+签名）可以让接收方能够确定这笔交易一定是发送者发起的。签名由私钥生成（私钥丢了，账号就丢了；私钥泄露，签名就泄露了，相当于别人也掌握了交易权限；）
- 发送币的数量
- 可选数据：转账留言、调用智能合约的参数
- GasLimit:  比特币网络坊中，限制最大运算次数。一次运算等同汇编语言的一个命令执行，合约会转成汇编语言的命令。而合约执行受参数影响，执行前命令执行数是不确定的，只能在执行前限制最大运算次。限制最大运算次，超过则放弃本次执行。
- GasPrice: 比特币网络中，每次计算需要的费用，越高优先级越高。

Gas：燃料（抽象），节点（旷工的矿机）存储数据、验证数据的算力成本。Gas 越高，旷工收益更高，执行的优先级越高。

手续费：GasLimit * GasPrice
- 对于交易者，限制最大运算次，每次计算的费用控制手续费最大支出。避免有问题的智能合约消耗过多币造成损失。也可以核对账号是否有足够的币进行操作，执行完有多余的手续费会返还。
- 对于区块链：避免有问题的智能合约导致网络资源的无限制消耗。区块链的节点算力有限，可以通过 gas 价格自动调节市场，使得算力用在最有效的地方。

如果执行失败，可能是 GasLimit 设置太小了，如果目前的数值确实过小，可以放大些限制最大运算次数使得合约可以正常执行。如果一个交易因为 GasLimit 设定太低而执行失败，那么所支付的手续费（即已经消耗的 Gas）不会退回，这是为了补偿旷工已经进行的计算工作。




## UTXO
### 基础概念

区块链的特性：一个东西发给别人后，自己就没了。
比特币网络通过 UTXO (`Unspent Transaction Outputs` 未花费的交易输出)实现。
- `Unspent`: 未花费/未使用
- `Transaction`: 交易
- `Outputs`: 输出

在比特币系统中没有“账户”或“余额”的概念，交易的输入和输出是基于 UTXO 模型的.

每个输入都是之前交易的一个输出（UTXO），而每个交易输出可以成为未来交易的输入。

Alice 拥有10个比特币并想要支付给 Bob 4个比特币：
在创建交易时，Alice 的钱包需要明确指出是哪一个或者哪些 UTXO 被用作本次支付的资金来源。
- `Input: Alice address, Referenced UTXO value (10)`
- `Output 1: Bob address, Amount (4)`
- `Output 2: Alice new address (找零地址), Amount (6)`

这样，Alice 原来的10个比特币的 UTXO 就被消费了，而新生成的两个 UTXO（一个是 Bob 的4个比特币，一个是 Alice 的6个比特币找零）则可以在未来的交易中使用。

虽然看起来通过钱包地址可以查询到“余额”，实际上这个余额是通过统计该钱包地址可以引用的所有未花费的 UTXO 计算出来的。
每次交易时，必须指明具体使用哪些 UTXO 作为资金来源，这是比特币协议核心的一部分。

### UTXO 携带额外信息
在比特币中，交易的记录是通过在全节点上维护的区块链完成的，而交易的“状态”实际上是通过追踪所有未花费的交易输出（UTXOs）来隐式表示的，并没有真实的状态变量。

如果对其进行扩展，使其能够携带更多信息（状态）。
则可以直接在交易层面支持更复杂的逻辑和条件，是智能合约的产生的前提，使得 UTXO 不仅限于转账和支付，还能执行各种复杂的操作。

例如转账时，携带更多信息可以携带留言：
描述一个数字艺术作品的唯一标识符、艺术家的名字、作品的标题等，还有“未售“状态。这样这个 UTXO 就代表着这个数字艺术作品，UTXO 归属于谁，数字艺术作品就归属谁。而"已售"和"未售"这样的状态信息可以用在网页上，供其他用户预览和选购。这便是非同质化资产（NFTs）。


携带更多信息，可以为后续的智能合约模型提供数据来源，使得（智能合约/程序/规则）能够执行，执行后改变账目的状态，而智能合约执行的环境就是 EVM（以太坊虚拟机）

当然，有些些区块链平台如 Cardano，试图将 UTXO 模型与智能合约功能结合起来。在这种情况下，UTXO 可以携带额外的数据和规则（可以视为简单的智能合约逻辑），这些数据和规则定义了 UTXO 如何被消费，从而实现了在 UTXO 模型上执行智能合约的能力，称为 EUTXO（扩展的未花费交易输出模型）。

总结：UTXO 携带更多信息可以为后续的智能合约模型服务，在部分区块链平台 UTXO 也可以携带规则，从而实现在 UTXO 模型上执行智能合约的能力


## 智能合约

### 智能合约定义
智能合约跟账号一样，只要创建出来的地址符合规则，就会被区块链认可，任何人都可以创建智能合约。

无法修改：一旦部署，无法修改。
强制性：合约是代码执行，一满足规则便会执行。

### 部署智能合约

发起 UTXO 
- 接收地址：空
- 可选参数：智能合约编译的结果




## EVM

### 定义
EVM (以太坊虚拟机)是智能合约的运行环境，运行在一个**完全隔离，不能接触外部网络、文件系统的沙箱**里。

可以通过预言机(Oracles)获取链外数据，是一种第三方服务，作为区块链和外部世界之间的桥梁。

### 获取链外数据的风险和措施

典型例子：交易所
Web 3 之前发生了一个重大的安全问题，有人拿了几百万美金，把交易所币的价格砸下来，错误的价格触发智能合约的规则，有大量的资产被清算。攻击者通过买回低价资产到别的地方卖掉从而获利，而同时对其他市场参与者造成重大损失。攻击的成本就几百万美金，但赚了千万美金。

原因：
- 合约是代码执行，具有强制性。
- 外部馈入的价格错误：合约通过预言机 (Oracles)获取链外数据风险大，许多中心化金融（DeFi）平台和智能合约使用外部的价格馈入（例如，通过预言机服务）来获取资产的当前市场价格，用于决定是否需要对抵押在智能合约中的资产进行清算。

解决方案：清算激励（惩罚激励）、套利激励

清算激励：指在去中心化金融（DeFi）系统中给予那些执行清算操作，将借贷人的资产以折扣的方式出售，主要目的是保护借贷人的资产，且是对参与者（清算者）的一种奖励。从参与方的角度，叫清算激励。从借贷人角度，对借贷人进行惩罚，让他们资产折扣低于市场价出售，激励协助的清算者，也叫惩罚激励。

套利激励：有人（比如套利者）认为外部馈入的价格不准确（例如，它可能比实际市场价格低），他们可以利用这一差异进行套利。这意味着他们可以购买被低估的抵押物，并在其他地方以更高的价格出售。如果他们成功地证明了价格馈入的错误（对比不同平台同一资产的价值，一般都是通过交易来证明。），智能合约可能会奖励他们，作为纠正价格错误的激励。通过激励个人纠正不准确的价格信息，它有助于保持 DeFi 平台的价格与全球市场价格一致，也有助于确保借贷安全，防止借贷平台因抵押品价值不足而损失资金。从稳定价格，抵御砸盘方面，套利激励比清算激励的效果更好。









