
## 基础概念

- 【区块链】是一种技术
- 【比特币】是基于区块链的第一代加密货币，在比特币网络上使用。
- 【比特币网络】主要是一个加密货币系统，主要用于点对点的货币交易。仅仅支持有限的脚本语言合约功能。
- 【以太币】是在以太坊上使用的货币，在以太坊上作为主币。
- 【以太坊网络】是一个提供更广泛功能的区块链平台，支持各种去中心化应用和智能合约。


## 区块链网络

### 组成

区块链网络是个账本，以太币在物理上不存在的，一个用户有多少钱，并不是有对应的哪一个币归属他，只是账本上记录他具有多少钱。

区块链网络是去中心化的，由成千上万的节点（旷工的矿机）组成。

### 技术实现

区块链技术实现上是由一个个区块按照时间顺序连接起来的，并且每个区块都包含了一段时间内发生的所有交易信息。区块链的设计确保了历史数据的**不可篡改性**和**透明性**。任何人都可以使用**区块链浏览器**等工具，来查看包括每个区块的详细信息和每笔交易的历史记录。




### 区块链网络的问题

如以太坊:
1. 高耗能 （矿机耗电）：挖矿机制（工作量证明 POW，Proof of Work） ，POS
2. 小额交易成本高：交易手续费过高，因为交易池 gas 高优先被选择。为了被选择，成本被动的被提高了。
3. 隐私性：完全公开
4. 并发处理能力差：每秒 10 ~ 20 笔交易

### 区块链的不可能三角

任何区块链系统都只能同时实现这三个目标中的 2 项，第 3 项会被牺牲。
- 去中心化：**不依赖**于任何**中央权威**来进行运作
- 安全性：指的是网络能够抵抗各种攻击，**保证交易数据的完整性和正确性**。涉及到加密、共识机制和其他安全协议。
- 可扩展性：指网络处理交易的能力，保持合理的速度和成本。通常是通过提高**交易吞吐量**和减少**确认时间**来衡量的。如果一个网络可以快速、高效地处理大量交易，那么它就更有可能满足不断增长的用户需求和应用场景。

>1. **比特币（Bitcoin）**：
    - **去中心化**：高，比特币网络由全球成千上万的节点组成。
    - **安全性**：高，比特币安全性非常强，利用了工作量证明（PoW）机制来确保网络安全。
    - **可扩展性**：低，比特币的交易吞吐量相对较低（大约 7 笔交易/秒），交易确认时间较长。
>2. **以太坊（Ethereum）**（在未完全实施分片和升级前）：
    - **去中心化**：高，以太坊也是一个全球性的去中心化网络。
    - **安全性**：高，以太坊提供了智能合约的执行环境，保证了合约的安全执行。且利用了工作量证明（PoW）机制来确保网络安全。
    - **可扩展性**：中到低，尽管比比特币有所改进，但在升级前，以太坊仍然面临可扩展性挑战。
>3. **EOS**：
    - **去中心化**：中到低，EOS 使用的是委托权益证明（DPoS）共识机制，只有 21 个主节点参与区块的产生。
    - **安全性**：中，虽然有一定的安全措施，但相比于完全去中心化的网络，其安全性被认为是有折衷的。
    - **可扩展性**：高，EOS 设计了高吞吐量的架构，目标是实现更快的交易速度和更高的可扩展性。
>4. **以太坊 2.0（Ethereum 2.0）**（在进行分片和其他升级后的状态，还未升级完成）：
	- **去中心化**：中到高，以太坊 2.0 通过引入权益证明（PoS）共识机制，意在保持网络的去中心化特性，同时降低参与门槛，理论上允许更多个体参与网络的维护。
	- **安全性**：预期高，需要验证。通过转换到 PoS 机制和新增的安全特性（如验证者激励措施），以太坊 2.0 旨在维持或增强其网络的安全性。不过，这需要在实践中经过时间检验。
	- **可扩展性**：高，这是以太坊 2.0 升级的主要目标之一。通过实施分片技术，以及可能的 Layer 2 扩展解决方案，以太坊 2.0 旨在显著提高交易处理能力和网络的整体性能。



## 挖矿

### 本质

挖矿的本质是哈希运算，通过输入参数，进行一个哈希运算，得出一个哈希值。### 投票-算力
选择交易（判断交易合法）后，广播给所有人，大多数节点同意，则成立。

问题：谁有投票权，Membership，有恶意节点将会影响投票，例如女巫攻击（sybil  attack）（童话故事里女巫可以伪装任何人）。
解决方案：
1. 联盟链，能确保参与人都是好的，没有恶意节点。但中央了
2. 投票用算力决定，而不是数量决定。

比特币中不是按节点数量来决定投票结果，是用算力来决定。这样就解决了女巫攻击，女巫攻击只能伪装更多的节点，但没法提高算力。

其他节点收到广播后验证，Block Head 正确性，里面的 Target 的 nBits 符合比特币规则，Nonce 符合 Target 等。

验证完认可新区块，继续新区块往下扩展。

比特币的共识是账本，而账本只能记账人通过新区块写入，新区块的产生只能靠 hash。
Hash 的 puzzle friendly 保证了没有捷径，只能靠算力。所以说投票权是看算力而不是节点数量。


### 最长链原则

有分叉时，以最长链为合法链。可以避免 forking attack？

同一时间产生新区块或广播延迟，产生不同节点视图时，也用最长链原则使得整个区块链一致。



如果这个哈希值小于或等于目标值（或者要特定数量的零开头），则意味着成功挖到一个新区块，将其广播到网络。这个新区块被网络上的其他节点验证和确认，如果这个新区块就被确认，矿工将会收到新生成的币（区块奖励），且执行新区块的所有交易，获取新区块所有交易的手续费。

挖矿（哈希运算）（工作量证明 PoW，Proof of Work）：
- 随机数（Nonce 值）：矿工挖矿就是变化这个随机值
- 即将要交易的账本：从交易池中选择手续费高的交易。（账本实际上是验证时已执行后的交易状态?）Merkle Tree 的 Root Hash?
- 上一个区块的哈希值


用户发起交易，将会进入一个交易池中。节点（如矿工节点）在交易池根据 Gas 价格（或其他因素）选择交易。

但由于大多数区块链，如比特币，对单个区块的大小有明确的限制，比特币区块的大小限制是1MB。矿工无法选择所有交易，为了利益最大化，矿工会挑选 GAS 价格高的（或其他因素）。矿工哈希运算得出的值满足目标值后，将会广播确认，确认成功后执行交易并获取手续费。


### 难度调整

比特币网络通过调整目标值（或者要特定数量的零开头）来控制挖矿难度，来确保全网平均每10分钟生成一个区块。

比特币挖矿难度的调整是根据前2016个区块的生成时间来决定的，大约每两周（实际上是每2016个区块）调整一次。两周 20160 分钟，2016 个区块在两周生成一个区块 10 分钟。（比特币 10 分钟，以太坊大概 12 s）

如果这2016个区块的生成时间少于两周（即平均生成时间少于10分钟），这表明全网的算力增加了，挖矿变得更容易，因此系统会增大目标值，提高挖矿难度，使得新的平均生成时间大约10分钟一个区块。否则减小目标值，降低挖矿难度。

新的目标值计算公式：
![](../assets/20240309-13-08-53.png)


### 区块链接

通过哈希运算，即挖矿得出哈希值满足目标值条件后，矿工便挖掘出一个新的区块，这个区块携带者哈希值，上个区块的哈希值（即引用上一个区块）以及，这样就形成了区块链。


### 区块链有效链

 **挖掘新区块的广播具有传播时间**，与网络延迟类似，新区块从源节点广播到全网所有节点需要一定的时间。在这个过程中，如果有多个新区块被挖掘，不同节点可能接收到不同的新区块，形成不同的下一区块，随后这些节点用下一区块继续往后面挖矿添加新区块，产生了一条分支。
 
这个过程区块链出现分叉，即形成了**节点间的不同视图**。

当产生分叉时，就需要**共识机制**来确保一致性，区块链按照“**最长链原则**”作为共识机制，接受最长的链作为有效链。其他分叉的区块被废弃时（被废弃的区块通常被称为“孤块”），其中的交易会被放到交易池中，等待矿工选择。

孤块中的交易实际上是被执行了，但因为孤块不在区块链主链上，所以不被确认。
执行不意味着确认，只有这个区块被加入到区块链的主链中，这个交易才被视为“确认”，并且其结果被整个网络认可。



### 区块生成的时间不宜过短
区块生成时间间隔，是为了确保网络有足够的时间让新的区块传播，以及进行验证。

举个例子，生成区块的时间被设置为 5 s，这个时间是区块链调整目标难度后控制的，并不固定，会随着区块链算力的浮动变化。可能在某一次哈希运算时，真实生成区块的时间变成 3 s 或 1 s 甚者更短。

- **孤块（Orphan Blocks）增加**：在这么短的时间内，不同的矿工可能几乎同时挖掘到新的区块。由于信息传播到整个网络需要时间，这可能导致多个有效的区块竞争成为链上的下一个区块。这种情况下，只有一个区块会被接受，其他的则变成孤块，导致挖矿工作的浪费。

- **重组链攻击的难度降低**：如果区块的生成时间设置得很短，那么**在相同的时间内可以生成更多的区块**。理论上，这使得一个拥有大量计算能力的攻击者能够更快地产生区块，从而更快地构建一个私有链。攻击者创建一个比公共链更长的链。通过最长链的共识机制，就可以用私链取代公共链了。生成时间设置得很短，**攻击的时间成本降低了**，使得攻击变得相对容易。（现实中上，攻击者需要有超过网络50%的计算能力，只不过花费的时间成本降低了）


### 区块链的区块大小有限制的原因

1. **避免网络拥堵**：**确保交易可以在合理的时间内得到确认**。因为预验证一个超大区块需要更多的时间和计算资源，当矿工选择大量的交易，将会导致区块链的效率降低。限制大小限制意味着一个区块只能包含有限数量的交易，促进了交易的高效处理。
2. **保持区块链的去中心化**：限制区块大小有助于保持网络的去中心化，因为如果区块过大，那么只有那些拥有高性能计算能力的个体或实体才能有效地参与挖矿，因为验证交易过程太长了，验证完才能挖矿。这将导致网络的中心化，损害区块链的基本原则。

### 新区块生成跟挖比特币有什么联系

挖矿实际上是创建新区块的过程。矿工通过工作量证明 （POW）挖矿，成功的矿工可以将新的交易打包成一个区块，然后将这个区块添加到区块链上。作为奖励，矿工会收到**新生成的比特币（区块奖励）** 以及区块中所有交易的**手续费**。

在区块链网络确认后，**新区块的生成直接关联到新比特币的产生（通过区块奖励）**，随着每个新区块的加入，**区块链被进一步延伸，同时增加了网络的安全性和去中心化程度**。每当一个新区块被成功挖掘并加入到区块链中，新的比特币就被创造出来，直至达到总量上限。

**区块奖励通过一笔铸币交易（coinbase transaction）得到：这是唯一产生币的渠道。**

一开始每个区块奖励 50 BTC，每有 21 w 个区块（大概 4 年）以后，区块奖励减半。

>  比特币的区块奖励大约每 4 年减半一次，这个设计是通过精确的计划和计算得出的。比特币网络被设计为每 10 分钟产生一个新区块。当累计产生 21 万个新区块时，区块奖励就会减半。由于每 10 分钟产生一个区块，21 万个区块总共需要 210 万分钟，这大约等于四年的时间。

### 币是有限的

币是有限的，不是因为技术问题，是因为人为规定了协议。比特币，协议规定最多只能存在2100万个比特币。

目的：
- **防止通货膨胀**：传统的法定货币可以由中央银行无限制地印制，可能导致通货膨胀。设定加密货币的最大供应量旨在避免由于货币过度发行而引起的通货膨胀。
- **提供价值存储**：通过限制总供应量，加密货币（如比特币）旨在提供一种长期的价值存储方式。就像黄金一样，其价值部分来自于其稀缺性。
- **激励机制**：在比特币的背景下，挖矿激励（区块奖励）随着时间的推移而减半，直到所有比特币都被挖掘出来。这种设计既鼓励了早期的网络参与者，又确保了比特币经济的长期可持续性。


币的总量如果要修改，需要更改区块链网络的基本共识规则，需要大多数节点达成一致同意，由于不同的利益相关者可能有不同的利益，**达成这样的共识通常非常困难**。

例如：比特币社区在2015年关于扩容问题，随着比特币用户数量的增长，网络的交易量也随之增加。这导致了交易确认时间变长，时间变长又导致手续费上涨的问题，比特币的区块大小限制为1MB，限制了每个区块可以包含的交易数量。
- **用户**：希望交易快速、费用低。对他们来说，提高网络吞吐量是优先考虑的事项。
- **矿工**：矿工从每个区块的交易费中获利。一方面，他们希望保持较高的交易费以增加收入；另一方面，太高的交易费可能减少用户使用比特币的意愿，从而影响矿工长期的利益。
- **节点运营者**（维护比特币网络的全节点）：更大的区块意味着需要更多的存储和带宽，支出更多。因此，他们可能对快速增加区块大小持保守态度。
- **开发者**：比特币核心开发者团队对网络的未来方向和技术改进有着显著的影响力。开发者间也存在分歧，关于如何平衡用户体验、网络安全和去中心化。

最终比特币通过分段见证、闪电网络解决方案来解决扩容问题。从2015年关于扩容问题产生，直到2017大多数节点意见一致并实施解决方案。讨论区块扩容就已经花了 2 年了，修改币总量带来的共识问题会困难无数倍。

### 币越来越难挖

1. **挖矿激励减半**是比特币协议的一部分，**减少一半的区域奖励**，大约**每四年**发生一次，这被称为“减半”（halving）。目的是控制比特币的新供应，使得比特币的发行速度逐步减慢，模拟稀缺资源的开采速率逐渐减少，最终在 2140 年左右达到 2100 万比特币的总量上限。减半确保了比特币不会因为过快的产生而失去稀缺性和价值。
2. 越来越多的矿工加入区块链网络和还有 GPU 性能提高，区块链网络的平均算力在提高，原有的算力会更不上，所以挖矿的难度总体上是增加的。

## 账号

### 如何生成账号

账号根据账户的合约代码，区分为个人账号、合约账号。

普通账号：
去中心化，不同区块链网络生成账号都是在本地生成，只是生成账号规则的不同，利用（公钥、私钥）根据不同生成规则生成账号地址。
1. 在**本地**生成 32/64 位 16 进制的**随机数**。
2. 随机数生成 **私钥**、**公钥**。
3. 公/私钥生成**账号地址**。

部分跨链钱包 app，是用同一公/私钥，在不同区块链上生成账号地址，由于生成规则不同，用一公/私钥在不同区块链上生成了不同的账号地址。实现一对多。

只要账号符合区块链生成规则，它就被视为有效地址，可以接收资产，没有传统意义上的“注册”过程。

新创建的账号虽然是有效地址，但由于没有人跟他交易过，区块链上没有它的交易记录，需要别的账号交易过来时才会产生交易记录。



智能合约账号：由普通账号发起一个交易，接受地址为空，智能合约的编译后字节码作为交易的可选参数 (留言)被发送，区块链会根据发起交易的账户地址和该账户的当前交易数（nonce）自动计算出一个新的合约地址。这个过程确保每个合约地址都是独一无二的。

### 账号

账号通常包含以下元素：
- Nonce（实际上是计数器）：从0开始，并且每当该账号发起一笔新交易时，其 nonce 值就会递增。每笔交易都会包含该账号当前的 nonce 值。区块链网络会检查每个交易的 nonce 值，确保它是按顺序并且没有被使用过，被使用过了，那本次交易就被废弃了。防止重放攻击、重复交易。
- 账户目前的以太币余额 (主币）：以太币 (Ether)用于支付交易费用。以太币的最小单位为 Wei，最大单位为以太，`1 Ether=10^18 Wei`，`Wei` 单位很小是为了进行整数计算。
- 账户的合约代码：有的话为智能合约账号，没有为个人账号。
- 账户的存储： (默认为空)。合约账号存放存储数据（状态）和合约代码。

## 哈希

### 特性
- Puzzle friendly：通过某种方法预测或计算出特定的输出结果非常困难。
- **不可逆性**(hiding)：从**哈希值无法直接推导出原始输入数据**。这意味着如果你只知道一个区块的哈希值，你不能确定是哪个特定的输入产生了这个哈希值。**要求输入要足够大，每个输入概率足够均匀。** 如果输入被限定范围，则可以遍历所有输入去暴力算出。
- **强抗碰撞性**：找到两个**不同的输入，它们产生相同的输出哈希值**，在计算上是**极其困难**的。这保证了区块链网络的安全性，防止了某些类型的攻击。
- **确定性**：对于**相同的输入数据**，哈希函数**总是产生相同的输出哈希值**。这意味着如果输入数据没有变化，无论执行多少次哈希运算，结果都是一致的。
- **高效性**：哈希函数能够**快速计算**出输入数据的哈希值，即使是对于很大的数据集也能高效处理。

?签名用的随机源要确保随机，否则会泄露私钥？

### Merkle Tree

区块（ Block ）中用来存交易的数据结构，Merkle Tree 生成的 root hash 存在了区块的 Block Head 里。用来验证 Block Body 里的交易是否被篡改。任何一个交易被修改，都会影响 root hash 生成。
![](../assets/20240313-07-23-18.png)


## 区块 Block

### Full （validating）Node 全节点

保存所有信息，验证每一个交易。有 Block Head，Block Body。占资源大。


### Light （validating） Node 轻节点

区块链中大部分是轻节点，只有 Block Head，没法独立验证交易，需要利用区块链的信息（其他全节点的信息）做查询校验。最长见的是手机 app 钱包。


### Block Head

存储了宏观信息：
- BTC 比特币的的版本 vision
- 指向前一个区块的 hash 指针：指向上个区块的块头 Block Head，只有块头信息参与 hash。
- Merkle tree 的 root hash（所有交易的根 hash），保障交易列表不被篡改
- 两个挖矿值
	- Target：难度目标值的编码 （nBit）
	- Nonce：当前区块的随机值（32Bit，4 bytes）

？区块链有没有被篡改，只需要核对最后区块的 hash 是否正确，就知道有没篡改，问题是验证最后区块的 hash 不是得沿着区块链从头到尾 hash 整条区块链吗？

？Bitcode script
？Hash 只 hash block head？
### Block Body

包含详细信息：
- Translaction List 交易列表
？还有其他吗

### 验证交易存在 proof of inclusion

轻节点利用 Merkle proof 去验证交易是否存在区块中。
Merkle proof ：在 Merkle Tree 中这个交易到根节点的路径。

Merkle proof 可以证明 merkle tree 里包含某个交易。时间成本很低，O (log (n))。

如果你转钱到我的账户，你需要提供 merkle proof。我验证后 root hash 一致，证明你转钱成功写到区块链里了。


首先轻节点向别的全节点，获取 merkle proof（路径）上每个节点所需要的 hash 值。通过这笔交易生成的 hash，沿着 merkle proof 从下往上验证，加上全节点提供的所需 hash，就可以计算出 root hash，root hash 与轻节点 block head 的 root hash 一致，这笔交易就在这个区块中。

？同学问的是，旁边篡改交易，提供的 hash 变了，导致交易验证失败的情况？


### 验证交易不存在

笨办法：验证整棵树，这样知道叶节点交易没被篡改，没在叶节点交易里就是不存在。

全节点整颗 merkle tree 发给轻节点，轻节点进行整棵树计算验证，如果 root hash 一致，证明树没被篡改，叶节点只有这些，这笔交易不在叶节点里，交易不存在。时间复杂度 O(n)

好的解决方案（比特币没有）：
叶节点有序（sorted merkle tree），只验证 merkle proof。
如果叶节点有序（根据 hash 从小到大），则找到交易这个节点应该插入的位置，将左右两个交易去走完 merkle proof，如果 roof hash 一致，证明这两个交易没被篡改，他们中间确实没有我们要找的这个交易。这样时间复杂度 O (log (n))。也不用去验证整棵树。


## 比特币共识（consensus in BitCode）

假设大多数节点是好的，以此设计共识协议
？有坏的怎么解决
？坏节点不认可好账单
？坏节点制造坏账

### 投票-算力
选择交易（判断交易合法）后，广播给所有人，大多数节点同意，则成立。

问题：谁有投票权，Membership，有恶意节点将会影响投票，例如女巫攻击（sybil  attack）（童话故事里女巫可以伪装任何人）。
解决方案：
1. 联盟链，能确保参与人都是好的，没有恶意节点。但中央了
2. 投票用算力决定，而不是数量决定。

比特币中不是按节点数量来决定投票结果，是用算力来决定。这样就解决了女巫攻击，女巫攻击只能伪装更多的节点，在节点数量上提高，但没法提高算力。

其他节点收到广播后验证，Block Head 正确性，里面的 Target 的 nBits 符合比特币规则，Nonce 符合 Target 等。

验证完认可新区块，继续新区块往下扩展。

比特币的共识是账本，而账本只能记账人通过新区块写入，新区块的产生只能靠 hash。
Hash 的 puzzle friendly 保证了没有捷径，只能靠算力。所以说投票权是看算力而不是节点数量。


### 最长链原则

有分叉时，以最长链为合法链。可以避免 forking attack？

同一时间产生新区块或广播延迟，产生不同节点视图时，也用最长链原则使得整个区块链一致。






## 交易

### 账本结构

每个区块链网络，都有自己的账本结构：
- 以太坊网络基于账户的模型
- 比特币网络基于 UTXO 的模型

账户模型和 UTXO 模型有本质的不同，基于账户的模型直接反映每个账户的当前状态，而 UTXO 模型通过跟踪每个未花费的输出来确定账户的余额。

基于账户的模型：账户的余额是直接从以太坊的全局状态中读取的，交易执行时，以太坊网络会进行验证并更新全局状态。

"状态"是指包括所有账户（包括普通用户账户和智能合约账户）的当前信息，包括账户的余额、存储的数据和智能合约的代码（当然代码一经发布就不可变）。

每次交易的本质上，是从一个明确的全局状态转移到另一个明确的全局状态，这些状态包括了所有账户的余额、合约状态和其他相关信息。与 UTXO 模型，有本质的不同。

**区块链网络决定了账本结构，在该区块链网络中每次交易都是基于该账本结构。** 
- 区块链网络中可以交易主币，至于交易其他币种，需要通过代币 **WBTC (Wrapped Bitcoin)** 实现
- 例如：在**以太坊网络**中交易比特币，比特币以**代币**的形式交易，以太坊网络的账本结构是**账户模型**。



### 稳定币

稳定币是**不具有波动性**的加密货币

Tether、USDC 都是和1 美元等价的稳定币，且是用法币抵押的（有些不是用法币，但这两家最大的稳定币用的是法币抵押），每造出一枚稳定币意味着他们的银行里有一美元，且接受检查，以此来建立信用。
稳定币的必要条件是稳定，按照**绝对理想化**的情况，稳定币的价值是稳定的，可以粗略理解为数字法币。

所以在加密货币交易所、数字钱包服务和其他金融平台上，可以将 1美元兑换成 1USDC，或者将 1 USDC 兑换成 1美元。

同时，稳定币可以和 ETH 以及其它以太坊代币互相转换，**稳定币提供了一个相对稳定的价值存储手段**，因为许多加密货币（包括以太坊的 ETH）经常经历剧烈的价格波动。

大量区块链系统对稳定币有强烈需求，稳定币的流入区块链系统，意味着区块链系统的资金变多，生态系统更活跃，有更多的应用和服务出现。稳定币的引入可以降低新用户的进入门槛，吸引更多的参与者进入区块链生态系统。这包括不仅限于投资者，还有开发者、普通用户。

区块链系统会用各种策略来吸引用户加入，比如以太坊有大量去中心化应用（DApps），如果想使用这些 DApp 的功能，就需要对接进入以太坊。
再比如一些去中心化金融（DeFi），开发各种 DeFi 应用，如借贷平台，将稳定币放入他们的借贷池赚取即时收益。就像在金融界一样，你出借稳定币，且可以随时撤回，获取收益。平台由可以拿你的这部分存款去操作钱滚钱。


### 代币

在以太坊中，主币是以太币（ETH），它是以太坊网络的原生货币，用于支付交易费用和执行智能合约等。**当在以太坊中交易比特币时，比特币不会直接存在，而是以代币的形式存在**，这种代币通常被称为 **Wrapped Bitcoin（WBTC）**。

WBTC 是一个遵循以太坊标准（如 ERC-20）的代币，每个 WBTC 都与实际的比特币以1:1的比例锚定，这意味着每个 WBTC 的背后都有相等数量的比特币被锁定。

在以太坊网络中，**WBTC（或其他类型的代币化比特币）的价值可以用以太币来衡量**，交易和计算费用在以太坊上用**以太币**支付。但是，WBTC 的背后价值确实代表着比特币。这样，用户就可以在以太坊上交易比特币。

稳定币在这些区块链中也是以代币的形式存在。



### 交易的特性

只能增量操作：增加交易，无法删除、修改交易。

形式：
- 发起交易只交易币
- 调用一个智能合约


### 每次交易的基本元素

无论是哪种账本结构，交易的基本元素通常包括：
- 接收地址：合约账号地址或个人账号地址
- 发送者签名：用于非对称加密验证发送人，（公钥+签名）可以让接收方能够确定这笔交易一定是发送者发起的。签名由私钥生成（私钥丢了，账号就丢了；私钥泄露，签名就泄露了，相当于别人也掌握了交易权限；）
- 发送币的数量
- 可选数据：转账留言、调用智能合约的参数
- GasLimit:  **比特币网络中**，限制最大运算次数。一次运算等同汇编语言的一个命令执行，合约会转成汇编语言的命令。而合约执行受参数影响，执行前命令执行数是不确定的，只能在执行前限制最大运算次。限制最大运算次，超过则放弃本次执行。
- GasPrice: **比特币网络中**，每次计算需要的费用，越高优先级越高。

Gas：燃料（抽象），节点（旷工的矿机）存储数据、验证数据的算力成本。Gas 越高，旷工收益更高，执行的优先级越高。

手续费：GasLimit * GasPrice
- 对于交易者，限制最大运算次，每次计算的费用控制手续费最大支出。避免有问题的智能合约消耗过多币造成损失。也可以核对账号是否有足够的币进行操作，执行完有多余的手续费会返还。
- 对于区块链：避免有问题的智能合约导致网络资源的无限制消耗。区块链的节点算力有限，可以通过 gas 价格自动调节市场，使得算力用在最有效的地方。

如果执行失败，可能是 GasLimit 设置太小了，如果目前的数值确实过小，可以放大些限制最大运算次数使得合约可以正常执行。如果一个交易因为 GasLimit 设定太低而执行失败，那么所支付的手续费（即已经消耗的 Gas）不会退回，这是为了补偿旷工已经进行的计算工作。交易失败会回滚所有已执行的命令。

### 交易过程

- **交易进入交易池**：当用户发起交易后，该交易首先被广播到网络，进入到交易池（mempool）中。
- **交易的选择和打包**：节点（如矿工节点）从交易池中选择交易进行打包时，是基于他们希望最大化自己收益的目的，通常优先选择 Gas 价格高的交易。
- **交易的预验证**：节点（如矿工节点）在交易池根据 Gas 价格（或其他因素）选择交易时，会对交易进行初步的格式和有效性检查，校验不通过，矿工会忽略该交易。
	- 验证账户余额是否足够支付交易币和手续费（GasLimit * GasPrice），账号余额不够则返回错误
	- 交易格式是否正确（符合交易的基本元素要有）
	- 签名是否有效
	- Nonce 是否和发送交易的匹配且不重复
	- 预验证合约代码，合约的代码在矿工的 EVM 中真实执行，确保所有状态的更新都是有效的。
- **矿工挖矿与区块确认**：矿工通过哈希运算找到符合难度目标的值，成功挖到一个新区块时，将其广播到网络，广播时会携带执行后的交易的最终状态。新区块会在网络上被其他节点验证和确认。
- **交易的执行**：其实一旦交易被选择打包时，它就在矿工的 EVM 中执行了（预验证时），广播时也是将执行后的交易的最终状态广播出去，配合新区块哈希给其他节点验证。所以一旦验证成功，就链接到主链上了，后续并没有交易的执行这个过程，在验证时就已经执行完成了。
- **合约执行与异常处理**：如果预验证时合约代码执行耗尽燃料而转移失败，生成 `Out-of-gas` 异常，并回滚合约已执行命令（本质上也不需要回滚，因为还没链接到主链，不被认可的），已消耗的手续费交给旷工。


矿工在选择交易时，会对交易进行预验证，会在矿工的 EVM 环境中执行智能合约的代码，得到执行后的交易状态。后续成功挖到新区块时，会将**交易的最终状态**还有 Nonce 值，新区块哈希值等广播给其他节点，其他节点会验证区块的有效性（包括验证工作量证明、交易的有效性、状态的转换是否正确等，会在他们自己的 EVM 中执行合约进行验证）。一旦确认新区块有效，则新区块会链接到他们的区块链版本中。




## UTXO
### 基础概念

区块链的特性：一个东西发给别人后，自己就没了。
比特币网络通过 UTXO (`Unspent Transaction Outputs` 未花费的交易输出)实现。
- `Unspent`: 未花费/未使用
- `Transaction`: 交易
- `Outputs`: 输出

在比特币系统中没有“账户”或“余额”的概念，交易的输入和输出是基于 UTXO 模型的.

每个输入都是之前交易的一个输出（UTXO），而每个交易输出可以成为未来交易的输入。

Alice 拥有10个比特币并想要支付给 Bob 4个比特币：
在创建交易时，Alice 的钱包需要明确指出是哪一个或者哪些 UTXO 被用作本次支付的资金来源。
- `Input: Alice address, Referenced UTXO value (10)`
- `Output 1: Bob address, Amount (4)`
- `Output 2: Alice new address (找零地址), Amount (6)`

这样，Alice 原来的10个比特币的 UTXO 就被消费了，而新生成的两个 UTXO（一个是 Bob 的4个比特币，一个是 Alice 的6个比特币找零）则可以在未来的交易中使用。

虽然看起来通过钱包地址可以查询到“余额”，实际上这个余额是通过统计该钱包地址可以引用的所有未花费的 UTXO 计算出来的。

每次交易时，必须指明具体使用哪些 UTXO 作为资金来源，这是比特币协议核心的一部分。
资金来源 UTXO，本质上是指定了本次这个输入 UTXO，是产自哪个 UTXO 的输出（我们这里称他为源 UTXO）:
- 源 UTXO（产生资金来源 UTXO） 的 hash 。
- 下标：资金来源 UTXO 作为源 UTXO 的第几个输出。

UTXO 存放在 Block Body 中，在区块链的全节点里。

### UTXO 携带额外信息
在比特币中，交易的记录是通过在全节点上维护的区块链完成的，而交易的“状态”实际上是通过追踪所有未花费的交易输出（UTXOs）来隐式表示的，并没有真实的状态变量。

如果对其进行扩展，使其能够携带更多信息（状态）。
则可以直接在交易层面支持更复杂的逻辑和条件，是智能合约的产生的前提，使得 UTXO 不仅限于转账和支付，还能执行各种复杂的操作。

例如转账时，携带更多信息可以携带留言：
描述一个数字艺术作品的唯一标识符、艺术家的名字、作品的标题等，还有“未售“状态。这样这个 UTXO 就代表着这个数字艺术作品，UTXO 归属于谁，数字艺术作品就归属谁。而"已售"和"未售"这样的状态信息可以用在网页上，供其他用户预览和选购。这便是非同质化资产（NFTs）。


携带更多信息，可以为后续的智能合约模型提供数据来源，使得（智能合约/程序/规则）能够执行，执行后改变账目的状态，而智能合约执行的环境就是 EVM（以太坊虚拟机）

当然，有些些区块链平台如 Cardano，试图将 UTXO 模型与智能合约功能结合起来。在这种情况下，UTXO 可以携带额外的数据和规则（可以视为简单的智能合约逻辑），这些数据和规则定义了 UTXO 如何被消费，从而实现了在 UTXO 模型上执行智能合约的能力，称为 EUTXO（扩展的未花费交易输出模型）。

总结：UTXO 携带更多信息可以为后续的智能合约模型服务，在部分区块链平台 UTXO 也可以携带规则，从而实现在 UTXO 模型上执行智能合约的能力

### Double spending attack

双重支付攻击：恶意攻击者尝试将同一笔资产同时支付给两个或多个不同的接收者的行为。
防范双重支付攻需要用 id 和归属状态。

交易里面有一个公钥。发起交易者将会把公钥提供给接受者。而且交易里，币的来源指向的 UTXO 的输出，也有一个公钥指明了归属者。这两个公钥一对比就知道是否由币的拥有者发起的交易。


## 以太坊状态转移
### 基础概念

区块链的特性：一个东西发给别人后，自己就没了。
以太坊网络通过账号模型实现。

发起一个交易，交易成功后改变全局状态。这与 UXTO 完全不同（UTXO 交易完成没有更改全局状态，余额都是通过一条条 UTXO 计算出来的。）



## 智能合约

### 智能合约定义

智能合约：根据**事先**任意制订的**规则**来**自动转移数字资产**的系统。本质就是区块链上的代码，用来实现特定的功能。任何人都可以创建智能合约。

特点是：
- 无法修改：一旦部署，无法修改。
- 可不开源：合约上只有字节码，并没有源代码。但不开源对项目推广有阻力

智能合约本身**不会“自动”执行**。它们需要通过网络上的一个交易来触发。这意味着要执行合约中的某个函数或逻辑，**必须有人或某个程序发起一个交易，指向该合约的地址**，并提供适当的输入数据和足够的 Gas 费用。当区块链网络**处理这笔交易时**，合约代码会按照其编程逻辑**执行**。

“砸盘”或“暴跌”时，清算通常是**由清算人或套利者触发**的，他们监控市场条件和借贷平台的健康状况。当一个借款人的抵押品价值下降到某个临界点（清算阈值）时，这些**参与者**可以**发起清算交易**，以获得清算奖励。这个过程需要**主动监控和参与**，而**不是智能合约自己执行**。


### ABI

“应用程序二进制接口”（Application Binary Interface）。类似于 Web 2.0 开发中的 API（应用程序编程接口）。ABI 作为智能合约的接口，定义了合约中可调用的函数、它们的参数、返回值以及触发的事件等。

程序员在编译合约时会生成字节码（`bit code`），同时生成一个 JSON 格式的 ABI。ABI 提供给其他语言使得它们可以正常调用 ` bit code `。本质上只要 ` bit code ` 里有这个方法，而且提供了这个方法正确的 JSON，就能正常调用，没有认证过程，没有限制一定要来源官方提供的 JSON 链接才能调用。

ABI 一般提供在项目的 Github 或项目官方网站中。


### 生命周期

- 编写/编译合约：用 solidity 编写后进行编译，编译成可执行的字节码，即二进制指令。
- 测试合约：在部署到主网前，需要在测试网对合约进行测试，检查合约逻辑、寻找漏洞、验证功能和性能。
- 部署合约：由普通账号发起一个交易，接受地址为空，智能合约的编译后字节码作为交易的可选参数 (留言)被发送，区块链会根据发起交易的账户地址和该账户的当前交易数（nonce）自动计算出一个新的合约地址。这个过程确保每个合约地址都是独一无二的。部署是一个交易，会消耗 gas。
- 调用合约
	- 监听合约：状态值改变，触发一些事件，例如上报给区块链记录。后续可以用其他语言开发区监听区块链上这个特定的状态值是否改变，对接到自己的应用里。
	- 销毁合约：以太坊鼓励节省资源，从以太坊的全局状态中移除数据，网络会返还一定数量的 Gas 给触发自毁过程的交易，作为一种激励措施。



### 合约的透明度

虽然智能合约的字节码是公开的，但如果只有字节码而没有源代码，确实会很难理解合约内部的逻辑。
因此，为了透明性和可信赖性，开发者通常会在区块链上发布字节码的同时，在公共平台如 GitHub 上公开源代码，并通过各种工具对照字节码验证源代码的正确性。这种做法有助于社区审计和验证智能合约的行为。

不开源的项目，不利于推广，许多大型和流行的智能合约通常会选择开源。

### 智能合约钱包

? 是什么
### 合约的继承

合约的继承是在合约开发阶段发生的，合约一旦部署，就不可更改了。

合约的继承是倒序线性继承，最后部署的合约是主合约，所有父级合约的属性和功能都被合并到最终部署的合约中，也就是”主合约”。确保代码更易于管理和扩展。

> ? 归属到合约开发那边, 不应该放这里



## 去中心化金融 （DeFi）

### 定义

以太坊本身是一个开源的区块链平台，它提供了创建和运行去中心化应用（DApps）和智能合约的基础设施。以太坊提供了关键的基础设施，**DeFi 是构建在以太坊之上的应用层**，依赖智能合约。

DeFi 涵盖了广泛的金融服务，如：
**借贷**：用户可以借出或借入资金，借入通常通过**超额抵押**（抵押物价值高于借款价值）的方式。
**交易所**：去中心化交易所（DEX）允许用户直接交换不同的加密货币或代币。
**资产管理**：提供投资管理和其他理财产品，使用户能够管理和增长其加密资产。

### 清算激励

在去中心化金融（DeFi）系统中，一旦抵押资产的价值**跌破要求的最低抵押率**时，将会开发执行清算操作的权利，将借贷人的抵押资产以折扣的方式出售，主要目的是**保护借贷人的抵押资产**，且是对参与者（清算者）的一种奖励。**清算激励机制会吸引参与方介入，执行清算操作**。从参与方的角度，叫清算激励。从借贷人角度，对借贷人进行惩罚，让他们抵押资产折扣低于市场价出售，激励协助的清算者，也叫惩罚激励。


例如：
在以太坊中，借贷 10 以太币（ETH），由于 DeFi 平台要求超额抵押，抵押率为 150%。要求至少要有 15 ETH 价值的抵押物。
借贷人的抵押资产是代币（我们这里用 X 币代表），此时 X 币的市场价是，15 ETH 等价于 100 X 币，所以用了 100 X 币作为抵押，借出了 10 ETH。
假设平台规定最低抵押率为120%，**一旦抵押资产的价值低于这个抵押率，抵押资产就会进入可被清算的状态**。
随着市场变动，X 币的价值下降了，目前 11.9 ETH 等价于 100 X 币，接待人的抵押率为 119%，抵押资产就会进入可被清算的状态。
为了鼓励清算人参与清算，假设 DeFi 平台允许清算人以  95%折扣价购买接待人的抵押资产 100 个 X 币，这种折扣即为清算激励（购买的方式可以是折扣价价值的 ETH ）。折扣人比直接去 X 比平台购买还省了 5%。

对贷方的资金也有一定程度的保护，**如果没有清算者介入执行清算，抵押资产价值持续贬低的话，那么贷方资金也会亏损。**

只要抵押资产的价值低于抵押率，抵押资产就会进入清算状态。**DeFi 获取目前抵押资产的价值，就需要通过预言机，保证抵押物价值评估的准确性和及时性。**

预言机提供数据，主要是用做参数提供给智能合约去执行其逻辑，如更改清算状态。当然智能合约并不会自动执行，是由 DeFi 在链外开发的程序通过定时/监听/爬虫去发起交易执行智能合约，智能合约无法链接网络，需要根据预言机提供的数据（链外程序也可能使用其他数据源作为辅助决策供给智能合约参考），决定是否更改清算状态。


？补充在本平台，主币价格下跌，贬值，虽然标准币稳定。
？其他平台，以本币作为抵押资产的，触发清算。会一定程度影响其他币


### 套利激励

当套利者监控到相同资产，在本 DeFi 平台上预言机提供的价格，比其他市场或交易所上的价格低，纯在利润。这意味着他们可以利用这一差异进行套利。

套利者将会发起交易购入该低价资产，高需求将会提高低价市场的资产价格，同时在高价市场上出售资产会增加供应，从而降低那里的价格。两个市场达到了新的价格平衡，这种买卖活动有助于缩小不同市场间的价格差异。

**套利激励有助于维护整个 DeFi 生态系统中的资产价格一致性。**

## EVM

### 定义

EVM (以太坊虚拟机)是智能合约的运行环境，运行在一个**完全隔离，不能接触外部网络、文件系统的沙箱**里。

可以通过预言机(Oracles)获取链外数据，是一种第三方服务，作为区块链和外部世界之间的桥梁。

### 获取链外数据的风险和措施

典型例子：交易所
Web 3 之前发生了一个重大的安全问题，有人拿了几百万美金，把交易所币的价格砸下来，错误的价格触发智能合约的规则，有大量的资产被清算。攻击者通过买回低价资产到别的地方卖掉从而获利，而同时对其他市场参与者造成重大损失。攻击的成本就几百万美金，但赚了千万美金。

原因：
- 合约是代码执行，具有强制性。
- 外部馈入的价格错误：合约通过预言机 (Oracles)获取链外数据风险大，许多中心化金融（DeFi）平台和智能合约使用外部的价格馈入（例如，通过预言机服务）来获取资产的当前市场价格，用于决定是否需要对抵押在智能合约中的资产进行清算。

解决方案：清算激励（惩罚激励）、套利激励






## 共识机制

共识机制允许网络中的不同节点，在没有中央权威机构的情况下，就网络中的数据和交易记录达成一致意见。

目前共识机制有：
- 工作量证明 PoW (Proof of Work)，
- 权益证明 PoS（Proof of Stake）

对于目前以太坊区块链来说，达成共识意味着全网络中至少 66% 的节点（PoS）就网络的全局状态达成一致。

### 权益证明（Proof of Stake，PoS）

？什么是权益证明



## 以太坊 2.0

以太坊2.0还没有完全部署。这个升级是分阶段进行的，目前已经实施了一些关键的升级，例如 Beacon Chain 的引入，这是以太坊向权益证明（PoS）共识机制转变的重要一步。

2020 年 12 月 1 日，Beacon Chain 已于上线。
2022 年 9 月 15 日，以太坊完成从工作量证明（Proof of Work，PoW）转向权益证明（Proof of Stake，PoS）的转换。以太坊将完全采用权益证明机制

更多具体参考：[以太坊路线图 | ethereum.org](https://ethereum.org/zh/roadmap/)




### 分片技术

二层网络卷叠发展迅猛，目前已经不需要分片链了，分片链已经从以太坊的路线图中被移除。[以太坊路线图-分片 | ethereum.org](https://ethereum.org/zh/roadmap/#what-about-sharding)

以太坊 1.0 运行在一个单一的主链上，处理所有交易和智能合约操作。

二层网络卷叠（Layer 2 rollups）通过在以太坊主链之上处理交易和状态变更来增加网络的吞吐量，从而减少了主链的负载。


> 分片链：在以太坊 2.0 中，预计将有 64 个分片链，每个分片处理**一部分网络的交易和合约**，减轻了主链的负担，并允许整个区块链网络**同时处理更多事务**。分片的目的是**提高整个网络的吞吐量和效率**。

## 二层网络卷叠 （Layer 2 rollups）

属于以太坊 2.0 
### 定义

二层网络卷叠的目的：在不牺牲去中心化和安全性的情况下提高**可扩展性**，**提高交易吞吐量**。

一层网络 (L 1)：底层区块链，以太坊和比特币都是一层网络区块链。**二层网络建于其上**。
二层网络 (L 2)：以太坊**扩容解决方案**的统称。
	- 以太坊上的“卷叠”（rollups）
	- 比特币的闪电网络

同时，**二层网络在实现上是一个对以太坊进行扩展的单独区块链，一般由第三方提供** 。**用户可以在二层网络（第三方提供商）上发起交易**，而非直接提交给一层网络，所有二层网络项目上的交易活动**最终**都可以**回到一层网络区块链**。

当以太坊的需求较高时，网络会出现拥堵，会提高交易费用，承担不起费用的用户就会被“挤出”。
- 二层网络将数百笔脱链交易，**合并成一笔**单独的**一层网络交易**，交易费将大幅降低（一笔交易的手续费由数百笔脱链交易去平摊）。
- 安全性有保障：二层网络通过将交易数据提交到一层网络，卷叠可以继承以太坊的安全性。

[扩容 | ethereum.org](https://ethereum.org/zh/developers/docs/scaling/#layer-2-scaling)
[二层网络 | ethereum.org](https://ethereum.org/zh/layer-2/#what-is-layer-2)

### 卷叠

卷叠将**数百笔交易**打包（或“卷叠”）到一层网络的**一项交易**中。这会将一层网络的交易费分散到整个卷叠中的所有用户，降低每个用户的费用。

卷叠交易在二层网络执行，最终会将交易数据会提交到一层网络。

卷叠有两种形式: 乐观卷叠、零知识卷叠，它们的主要区别在于交易数据**提交到一层网络的方式**。


### 乐观卷叠

乐观卷叠被认为是“乐观的”，因为它们**假设链下交易是有效的**。乐观卷叠依**赖于欺诈证明方案**来检测交易计算不正确的情况。在**以太坊上提交卷叠批次后**，有一个**时间窗口（称为挑战期）**，在此期间任何人都可以通过**计算欺诈证明**来挑战卷叠交易的结果。
- 如果欺诈证明成功，则卷叠协议重新执行交易并相应地更新卷叠的状态，负责将错误执行的交易纳入区块的排序者会受到惩罚。
- 如果在挑战期过后卷叠批次仍然没有计算出欺诈证明，则将其视为有效并将交易数据作为 `calldata` 发布到主网。其他人可以继续扩建未经确认的卷叠区块

? 先打住，这块概念属于高级些的，目前底子弱暂时不碰，太多新概念产生
? 需要补充理解

乐观卷叠可以提供高达 10-100 倍的可扩展性改进

乐观卷叠从主链上发布交易结果或从 [Plasma 链](https://ethereum.org/zh/developers/docs/scaling/plasma/)获取安全性。




### 零知识卷叠
? 需要补充理解
使用有效性证明，其中的交易是脱链计算的，然后将压缩数据提供给以太坊主网，以证明其有效性。

### 卷叠回滚

在数据上传到一层网络后，**如果要回滚卷叠交易，需要回滚以太坊交易**。因为区块链是不可篡改的，但这种场景极少。

举个例子，如果二层网络 (乐观卷叠)发现了欺诈行为，确定需要回滚交易，二层网络可能需要执行一系列复杂的操作来恢复到欺诈行为发生之前的状态。这可能包括恢复账户余额、撤销非法交易导致的状态变更等，然后合并这些操作提交交易到一层网络。在极端情况下，这可能需要通过社区共识来决定如何恢复网络状态，并可能涉及到较为复杂的技术操作。

## 节点

比特币节网络中，任何机器都可以运行一个完整的比特币节点，包括: 
1. 钱包：用来发起交易，广播交易，跟踪和管理 UTXO。
2. 完整区块链：记录了所有交易历史，通过特殊的结构保证历史交易的安全性，并且用来验证新交易的合法性。
3. 矿工：通过记录交易及解密数学题来生成新区块，如果成功可以赚取奖励。
4. 路由功能：把其它节点传送过来的交易数据等信息再传送给更多的节点。

自己可以运行一个比特币的完整节点，当然这个比较消耗资源。一般用户都是使用**轻客户端或专用钱包软件**作为一个轻节点，具备少量功能，可以处理私钥和交易创建。



## 扩展：分布式共识（distribute consensus）

### 理论 1： FLP 的不可能结论（ impossibility result ）

在一个异步系统里，网络传输有延迟，不可能存在共识。

### 理论 2： CAP Theorem

任何分布式系统，最多满足下面三个其中两个
- Consistency:  一致性，所有节点在同一时间看到的数据是一致的
- Availability: 可用性，每个请求都会收到一个响应，无论响应是成功还是失败。
- Partition Tolerance：分区容忍性，指系统能够持续提供服务。系统的某些部分之间的网络通信失败，仍然能够继续运行的能力。

### 分布式共识的实现

分布式哈希表（distribute hash table）：`Key：Value` 组成的一个分布式系统
Paxos 协议：一致性

## 问题集

