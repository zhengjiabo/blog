
## 基础概念

- 【区块链】是一种技术
- 【比特币】是基于区块链的第一代加密货币，在比特币网络上使用。
- 【比特币网络】主要是一个加密货币系统，主要用于点对点的货币交易。仅仅支持有限的脚本语言和简单智能合约功能。
- 【以太币】是在以太坊上使用的货币，在以太坊上作为主币。
- 【以太坊网络】是一个提供更广泛功能的区块链平台，支持各种去中心化应用和智能合约。


## 区块链网络

### 组成

区块链网络是个账本，以太币在物理上不存在的，一个用户有多少钱，并不是有对应的哪一个币归属他，只是账本上记录他具有多少钱。

区块链网络是去中心化的，由成千上万的节点（旷工的矿机）组成。

### 技术实现

区块链技术实现上是由一个个区块按照时间顺序连接起来的，并且每个区块都包含了一段时间内发生的所有交易信息。区块链的设计确保了历史数据的**不可篡改性**和**透明性**。任何人都可以使用**区块链浏览器**等工具，来查看包括每个区块的详细信息和每笔交易的历史记录。




### 区块链网络的问题

如以太坊:
1. 高耗能：挖矿机制（工作量证明 POW，Proof of Work） ，POS
2. 小额交易成本高：交易手续费
3. 隐私性：完全公开
4. 并发处理能力差：每秒 10 ~ 20 笔交易


## 挖矿

### 本质

挖矿的本质是哈希运算，通过输入参数，进行一个哈希运算，得出一个哈希值。
如果这个哈希值小于或等于目标值（或者要特定数量的零开头），则意味着成功挖到一个新区块，将其广播到网络。这个新区块被网络上的其他节点验证和确认，如果这个新区块就被确认，矿工将会收到新生成的币（区块奖励），且执行新区块的所有交易，获取新区块所有交易的手续费。

挖矿（哈希运算）（工作量证明 POW，Proof of Work）：
- 随机数（Nonce 值）：矿工挖矿就是变化这个随机值
- 即将要交易的账本：从交易池中选择手续费高的交易，来构造一个新的区块
- 上一个区块的哈希值


用户发起交易，将会进入一个交易池中。节点（如矿工节点）在交易池根据 Gas 价格（或其他因素）选择交易。

但由于大多数区块链，如比特币，对单个区块的大小有明确的限制，比特币区块的大小限制是1MB。矿工无法选择所有交易，为了利益最大化，矿工会挑选 GAS 价格高的（或其他因素）。矿工哈希运算得出的值满足目标值后，将会广播确认，确认成功后执行交易并获取手续费。


### 难度调整

比特币网络通过调整目标值（或者要特定数量的零开头）来控制挖矿难度，来确保全网平均每10分钟生成一个区块。

比特币挖矿难度的调整是根据前2016个区块的生成时间来决定的，大约每两周（实际上是每2016个区块）调整一次。两周 20160 分钟，2016 个区块在两周生成一个区块 10 分钟。（比特币 10 分钟，以太坊大概 15 s）

如果这2016个区块的生成时间少于两周（即平均生成时间少于10分钟），这表明全网的算力增加了，挖矿变得更容易，因此系统会增大目标值，提高挖矿难度，使得新的平均生成时间大约10分钟一个区块。否则减小目标值，降低挖矿难度。

新的目标值计算公式：
![](../assets/20240309-13-08-53.png)


### 区块链接

通过哈希运算，即挖矿得出哈希值满足目标值条件后，矿工便挖掘出一个新的区块，这个区块携带者哈希值，上个区块的哈希值（即引用上一个区块）以及，这样就形成了区块链。


### 区块链有效链

 **挖掘新区块的广播具有传播时间**，与网络延迟类似，新区块从源节点广播到全网所有节点需要一定的时间。在这个过程中，如果有多个新区块被挖掘，不同节点可能接收到不同的新区块，形成不同的下一区块，随后这些节点用下一区块继续往后面挖矿添加新区块，产生了一条分支。
 
这个过程区块链出现分叉，即形成了**节点间的不同视图**。

当产生分叉时，就需要**共识机制**来确保一致性，区块链按照“**最长链原则**”作为共识机制，接受最长的链作为有效链。其他分叉的区块被废弃时（被废弃的区块通常被称为“孤块”），其中的交易会被放到交易池中，等待矿工选择。

孤块中的交易实际上是被执行了，但因为孤块不在区块链主链上，所以不被确认。
执行不意味着确认，只有这个区块被加入到区块链的主链中，这个交易才被视为“确认”，并且其结果被整个网络认可。




### 区块生成的时间不宜过短
区块生成时间间隔，是为了确保网络有足够的时间让新的区块传播，以及进行验证。

举个例子，生成区块的时间被设置为 5 s，这个时间是区块链调整目标难度后控制的，并不固定，会随着区块链算力的浮动变化。可能在某一次哈希运算时，真实生成区块的时间变成 3 s 或 1 s 甚者更短。

- **孤块（Orphan Blocks）增加**：在这么短的时间内，不同的矿工可能几乎同时挖掘到新的区块。由于信息传播到整个网络需要时间，这可能导致多个有效的区块竞争成为链上的下一个区块。这种情况下，只有一个区块会被接受，其他的则变成孤块，导致挖矿工作的浪费。

- **重组链攻击的难度降低**：如果区块的生成时间设置得很短，那么**在相同的时间内可以生成更多的区块**。理论上，这使得一个拥有大量计算能力的攻击者能够更快地产生区块，从而更快地构建一个私有链。攻击者创建一个比公共链更长的链。通过最长链的共识机制，就可以用私链取代公共链了。生成时间设置得很短，**攻击的时间成本降低了**，使得攻击变得相对容易。（现实中上，攻击者需要有超过网络50%的计算能力，只不过花费的时间成本降低了）


### 区块链的区块大小有限制的原因

1. **避免网络拥堵**：**确保交易可以在合理的时间内得到确认**。因为预验证一个超大区块需要更多的时间和计算资源，当矿工选择大量的交易，将会导致区块链的效率降低。限制大小限制意味着一个区块只能包含有限数量的交易，促进了交易的高效处理。
2. **保持区块链的去中心化**：限制区块大小有助于保持网络的去中心化，因为如果区块过大，那么只有那些拥有高性能计算能力的个体或实体才能有效地参与挖矿，因为验证交易过程太长了，验证完才能挖矿。这将导致网络的中心化，损害区块链的基本原则。

### 新区块生成跟挖比特币有什么联系

挖矿实际上是创建新区块的过程。矿工通过工作量证明 （POW）挖矿，成功的矿工可以将新的交易打包成一个区块，然后将这个区块添加到区块链上。作为奖励，矿工会收到**新生成的比特币（区块奖励）** 以及区块中所有交易的**手续费**。

在区块链网络确认后，**新区块的生成直接关联到新比特币的产生（通过区块奖励）**，随着每个新区块的加入，**区块链被进一步延伸，同时增加了网络的安全性和去中心化程度**。每当一个新区块被成功挖掘并加入到区块链中，新的比特币就被创造出来，直至达到总量上限。

### 哈希函数特性

- **确定性**：对于**相同的输入数据**，哈希函数**总是产生相同的输出哈希值**。这意味着如果输入数据没有变化，无论执行多少次哈希运算，结果都是一致的。
- **强抗碰撞性**：找到两个**不同的输入，它们产生相同的输出哈希值**，在计算上是**极其困难**的。这保证了区块链网络的安全性，防止了某些类型的攻击。
- **高效性**：哈希函数能够**快速计算**出输入数据的哈希值，即使是对于很大的数据集也能高效处理。
- **不可逆性**：从**哈希值无法直接推导出原始输入数据**。这意味着如果你只知道一个区块的哈希值，你不能确定是哪个特定的输入产生了这个哈希值。

### 币是有限的

币是有限的，不是因为技术问题，是因为人为规定了协议。比特币，协议规定最多只能存在2100万个比特币。

目的：
- **防止通货膨胀**：传统的法定货币可以由中央银行无限制地印制，可能导致通货膨胀。设定加密货币的最大供应量旨在避免由于货币过度发行而引起的通货膨胀。
- **提供价值存储**：通过限制总供应量，加密货币（如比特币）旨在提供一种长期的价值存储方式。就像黄金一样，其价值部分来自于其稀缺性。
- **激励机制**：在比特币的背景下，挖矿激励（区块奖励）随着时间的推移而减半，直到所有比特币都被挖掘出来。这种设计既鼓励了早期的网络参与者，又确保了比特币经济的长期可持续性。


币的总量如果要修改，需要更改区块链网络的基本共识规则，需要大多数节点达成一致同意，由于不同的利益相关者可能有不同的利益，**达成这样的共识通常非常困难**。

例如：比特币社区在2015年关于扩容问题，随着比特币用户数量的增长，网络的交易量也随之增加。这导致了交易确认时间变长，时间变长又导致手续费上涨的问题，比特币的区块大小限制为1MB，限制了每个区块可以包含的交易数量。
- **用户**：希望交易快速、费用低。对他们来说，提高网络吞吐量是优先考虑的事项。
- **矿工**：矿工从每个区块的交易费中获利。一方面，他们希望保持较高的交易费以增加收入；另一方面，太高的交易费可能减少用户使用比特币的意愿，从而影响矿工长期的利益。
- **节点运营者**（维护比特币网络的全节点）：更大的区块意味着需要更多的存储和带宽，支出更多。因此，他们可能对快速增加区块大小持保守态度。
- **开发者**：比特币核心开发者团队对网络的未来方向和技术改进有着显著的影响力。开发者间也存在分歧，关于如何平衡用户体验、网络安全和去中心化。

最终比特币通过分段见证、闪电网络解决方案来解决扩容问题。从2015年关于扩容问题产生，直到2017大多数节点意见一致并实施解决方案。讨论区块扩容就已经花了 2 年了，修改币总量带来的共识问题会困难无数倍。

### 币越来越难挖

1. **挖矿激励减半**是比特币协议的一部分，**减少一半的区域奖励**，大约**每四年**发生一次，这被称为“减半”（halving）。目的是控制比特币的新供应，使得比特币的发行速度逐步减慢，模拟稀缺资源的开采速率逐渐减少，最终在 2140 年左右达到 2100 万比特币的总量上限。减半确保了比特币不会因为过快的产生而失去稀缺性和价值。
2. 越来越多的矿工加入区块链网络和还有 GPU 性能提高，区块链网络的平均算力在提高，原有的算力会更不上，所以挖矿的难度总体上是增加的。

## 账号

### 如何生成账号

去中心化，不同区块链网络生成账号都是在本地生成，只是生成账号规则的不同，利用（公钥、私钥）根据不同生成规则生成账号地址。
1. 在**本地**生成 32/64 位 16 进制的**随机数**。
2. 随机数生成 **私钥**、**公钥**。
3. 公/私钥生成**账号地址**。

部分跨链钱包 app，是用同一公/私钥，在不同区块链上生成账号地址，由于生成规则不同，用一公/私钥在不同区块链上生成了不同的账号地址。实现一对多。

只要账号符合区块链生成规则，它就被视为有效地址，可以接收资产，没有传统意义上的“注册”过程。

新创建的账号虽然是有效地址，但由于没有人跟他交易过，区块链上没有它的交易记录，需要别的账号交易过来时才会产生交易记录。

账号根据账户的合约代码，区分为个人账号、合约账号。

### 账号

账号通常包含以下元素：
- Nonce（实际上是计数器）：从0开始，并且每当该账号发起一笔新交易时，其 nonce 值就会递增。每笔交易都会包含该账号当前的 nonce 值。区块链网络会检查每个交易的 nonce 值，确保它是按顺序并且没有被使用过，被使用过了，那本次交易就被废弃了。防止重放攻击、重复交易。
- 账户目前的以太币余额 (主币）：以太币 (Ether)用于支付交易费用。以太币的最小单位为 Wei，最大单位为以太，`1 Ether=10^18 Wei`，`Wei` 单位很小是为了进行整数计算。
- 账户的合约代码：有的话为智能合约账号，没有为个人账号，但未来可以改变转为智能合约账号。
- 账户的存储： (默认为空)。合约账号存放存储数据（状态）和合约代码。


## 交易

### 账本结构

每个区块链网络，都有自己的账本结构：
- 以太坊网络基于账户的模型
- 比特币网络基于 UTXO 的模型

账户模型和 UTXO 模型有本质的不同，基于账户的模型直接反映每个账户的当前状态，而 UTXO 模型通过跟踪每个未花费的输出来确定账户的余额。

基于账户的模型：账户的余额是直接从以太坊的全局状态中读取的，交易执行时，以太坊网络会进行验证并更新全局状态。

"状态"是指包括所有账户（包括普通用户账户和智能合约账户）的当前信息，包括账户的余额、存储的数据和智能合约的代码（当然代码一经发布就不可变）。

每次交易的本质上，是从一个明确的全局状态转移到另一个明确的全局状态，这些状态包括了所有账户的余额、合约状态和其他相关信息。与 UTXO 模型，有本质的不同。

**区块链网络决定了账本结构，在该区块链网络中每次交易都是基于该账本结构。** 
- 区块链网络中可以交易主币，至于交易其他币种，需要通过代币 **WBTC (Wrapped Bitcoin)** 实现
- 例如：在**以太坊网络**中交易比特币，比特币以**代币**的形式交易，以太坊网络的账本结构是**账户模型**。

### 代币

在以太坊中，主币是以太币（ETH），它是以太坊网络的原生货币，用于支付交易费用和执行智能合约等。**当在以太坊中交易比特币时，比特币不会直接存在，而是以代币的形式存在**，这种代币通常被称为 **Wrapped Bitcoin（WBTC）**。

WBTC 是一个遵循以太坊标准（如 ERC-20）的代币，每个 WBTC 都与实际的比特币以1:1的比例锚定，这意味着每个 WBTC 的背后都有相等数量的比特币被锁定。

在以太坊网络中，**WBTC（或其他类型的代币化比特币）的价值可以用以太币来衡量**，交易和计算费用在以太坊上用**以太币**支付。但是，WBTC 的背后价值确实代表着比特币。这样，用户就可以在以太坊上交易比特币。

### 交易的特性

只能增量操作：增加交易，无法删除、修改交易。

形式：
- 发起交易只交易币
- 调用一个智能合约


### 每次交易的基本元素

无论是哪种账本结构，交易的基本元素通常包括：
- 接收地址：合约账号地址或个人账号地址
- 发送者签名：用于非对称加密验证发送人，（公钥+签名）可以让接收方能够确定这笔交易一定是发送者发起的。签名由私钥生成（私钥丢了，账号就丢了；私钥泄露，签名就泄露了，相当于别人也掌握了交易权限；）
- 发送币的数量
- 可选数据：转账留言、调用智能合约的参数
- GasLimit:  **比特币网络中**，限制最大运算次数。一次运算等同汇编语言的一个命令执行，合约会转成汇编语言的命令。而合约执行受参数影响，执行前命令执行数是不确定的，只能在执行前限制最大运算次。限制最大运算次，超过则放弃本次执行。
- GasPrice: **比特币网络中**，每次计算需要的费用，越高优先级越高。

Gas：燃料（抽象），节点（旷工的矿机）存储数据、验证数据的算力成本。Gas 越高，旷工收益更高，执行的优先级越高。

手续费：GasLimit * GasPrice
- 对于交易者，限制最大运算次，每次计算的费用控制手续费最大支出。避免有问题的智能合约消耗过多币造成损失。也可以核对账号是否有足够的币进行操作，执行完有多余的手续费会返还。
- 对于区块链：避免有问题的智能合约导致网络资源的无限制消耗。区块链的节点算力有限，可以通过 gas 价格自动调节市场，使得算力用在最有效的地方。

如果执行失败，可能是 GasLimit 设置太小了，如果目前的数值确实过小，可以放大些限制最大运算次数使得合约可以正常执行。如果一个交易因为 GasLimit 设定太低而执行失败，那么所支付的手续费（即已经消耗的 Gas）不会退回，这是为了补偿旷工已经进行的计算工作。交易失败会回滚所有已执行的命令。

### 交易过程

- **交易进入交易池**：当用户发起交易后，该交易首先被广播到网络，进入到交易池（mempool）中。
- **交易的选择和打包**：节点（如矿工节点）在交易池根据 Gas 价格（或其他因素）选择交易，这个选择过程是矿工试图最大化其收益的结果。
- **交易的预验证**：节点（如矿工节点）在交易池根据 Gas 价格（或其他因素）领取交易后，会对交易进行初步的格式和有效性检查，校验不通过，矿工会忽略该交易。
	- 验证账户余额是否足够支付交易币和手续费（GasLimit * GasPrice），账号余额不够则返回错误
	- 交易格式是否正确（符合交易的基本元素要有）
	- 签名是否有效
	- Nonce 是否和发送交易的匹配且不重复
- **矿工挖矿与区块确认**：矿工通过哈希运算找到符合难度目标的值，成功挖到一个新区块时，将其广播到网络。这个新区块被网络上的其他节点验证和确认。
- **交易的执行**：一旦交易被包含在一个成功挖掘并被网络确认的区块中，它会被矿工执行。执行时扣除交易金额和手续费。将交易值转移给接收地址，如果是空地址也能转移成功，如果是合约地址则执行合约代码。执行完后，交易将正式地记录在区块链上。
- **合约执行与异常处理**：如果合约代码执行耗尽燃料而转移失败，生成 `Out-of-gas` 异常，并回滚合约已执行命令，已消耗的手续费交给旷工。


## UTXO
### 基础概念

区块链的特性：一个东西发给别人后，自己就没了。
比特币网络通过 UTXO (`Unspent Transaction Outputs` 未花费的交易输出)实现。
- `Unspent`: 未花费/未使用
- `Transaction`: 交易
- `Outputs`: 输出

在比特币系统中没有“账户”或“余额”的概念，交易的输入和输出是基于 UTXO 模型的.

每个输入都是之前交易的一个输出（UTXO），而每个交易输出可以成为未来交易的输入。

Alice 拥有10个比特币并想要支付给 Bob 4个比特币：
在创建交易时，Alice 的钱包需要明确指出是哪一个或者哪些 UTXO 被用作本次支付的资金来源。
- `Input: Alice address, Referenced UTXO value (10)`
- `Output 1: Bob address, Amount (4)`
- `Output 2: Alice new address (找零地址), Amount (6)`

这样，Alice 原来的10个比特币的 UTXO 就被消费了，而新生成的两个 UTXO（一个是 Bob 的4个比特币，一个是 Alice 的6个比特币找零）则可以在未来的交易中使用。

虽然看起来通过钱包地址可以查询到“余额”，实际上这个余额是通过统计该钱包地址可以引用的所有未花费的 UTXO 计算出来的。
每次交易时，必须指明具体使用哪些 UTXO 作为资金来源，这是比特币协议核心的一部分。

### UTXO 携带额外信息
在比特币中，交易的记录是通过在全节点上维护的区块链完成的，而交易的“状态”实际上是通过追踪所有未花费的交易输出（UTXOs）来隐式表示的，并没有真实的状态变量。

如果对其进行扩展，使其能够携带更多信息（状态）。
则可以直接在交易层面支持更复杂的逻辑和条件，是智能合约的产生的前提，使得 UTXO 不仅限于转账和支付，还能执行各种复杂的操作。

例如转账时，携带更多信息可以携带留言：
描述一个数字艺术作品的唯一标识符、艺术家的名字、作品的标题等，还有“未售“状态。这样这个 UTXO 就代表着这个数字艺术作品，UTXO 归属于谁，数字艺术作品就归属谁。而"已售"和"未售"这样的状态信息可以用在网页上，供其他用户预览和选购。这便是非同质化资产（NFTs）。


携带更多信息，可以为后续的智能合约模型提供数据来源，使得（智能合约/程序/规则）能够执行，执行后改变账目的状态，而智能合约执行的环境就是 EVM（以太坊虚拟机）

当然，有些些区块链平台如 Cardano，试图将 UTXO 模型与智能合约功能结合起来。在这种情况下，UTXO 可以携带额外的数据和规则（可以视为简单的智能合约逻辑），这些数据和规则定义了 UTXO 如何被消费，从而实现了在 UTXO 模型上执行智能合约的能力，称为 EUTXO（扩展的未花费交易输出模型）。

总结：UTXO 携带更多信息可以为后续的智能合约模型服务，在部分区块链平台 UTXO 也可以携带规则，从而实现在 UTXO 模型上执行智能合约的能力


## 以太坊状态转移
### 基础概念

区块链的特性：一个东西发给别人后，自己就没了。
以太坊网络通过账号模型实现。

发起一个交易，交易成功后改变状态。而 UTXO 交易完成没有更高全局状态，余额都是通过一条条 UTXO 计算出来的。


## 智能合约

### 智能合约定义
智能合约跟账号一样，只要创建出来的地址符合规则，就会被区块链认可，任何人都可以创建智能合约。

无法修改：一旦部署，无法修改。
强制性：合约是代码执行，一满足规则便会执行。

### 部署智能合约

发起 UTXO 
- 接收地址：空
- 可选参数：智能合约编译的结果




## EVM

### 定义
EVM (以太坊虚拟机)是智能合约的运行环境，运行在一个**完全隔离，不能接触外部网络、文件系统的沙箱**里。

可以通过预言机(Oracles)获取链外数据，是一种第三方服务，作为区块链和外部世界之间的桥梁。

### 获取链外数据的风险和措施

典型例子：交易所
Web 3 之前发生了一个重大的安全问题，有人拿了几百万美金，把交易所币的价格砸下来，错误的价格触发智能合约的规则，有大量的资产被清算。攻击者通过买回低价资产到别的地方卖掉从而获利，而同时对其他市场参与者造成重大损失。攻击的成本就几百万美金，但赚了千万美金。

原因：
- 合约是代码执行，具有强制性。
- 外部馈入的价格错误：合约通过预言机 (Oracles)获取链外数据风险大，许多中心化金融（DeFi）平台和智能合约使用外部的价格馈入（例如，通过预言机服务）来获取资产的当前市场价格，用于决定是否需要对抵押在智能合约中的资产进行清算。

解决方案：清算激励（惩罚激励）、套利激励

清算激励：指在去中心化金融（DeFi）系统中给予那些执行清算操作，将借贷人的资产以折扣的方式出售，主要目的是保护借贷人的资产，且是对参与者（清算者）的一种奖励。从参与方的角度，叫清算激励。从借贷人角度，对借贷人进行惩罚，让他们资产折扣低于市场价出售，激励协助的清算者，也叫惩罚激励。

套利激励：有人（比如套利者）认为外部馈入的价格不准确（例如，它可能比实际市场价格低），他们可以利用这一差异进行套利。这意味着他们可以购买被低估的抵押物，并在其他地方以更高的价格出售。如果他们成功地证明了价格馈入的错误（对比不同平台同一资产的价值，一般都是通过交易来证明。），智能合约可能会奖励他们，作为纠正价格错误的激励。通过激励个人纠正不准确的价格信息，它有助于保持 DeFi 平台的价格与全球市场价格一致，也有助于确保借贷安全，防止借贷平台因抵押品价值不足而损失资金。从稳定价格，抵御砸盘方面，套利激励比清算激励的效果更好。









